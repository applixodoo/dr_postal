# Migration Guide: dr_postal v19 â†’ v18

This document provides instructions for migrating the dr_postal module from Odoo v19 to v18.

## Overview

The module was originally developed for Odoo v19. Odoo v18 has a similar architecture but with some API differences. The migration should be relatively straightforward.

## Version Number

Update `__manifest__.py`:
```python
'version': '18.0.1.0.0',  # Changed from 19.0.1.0.0
```

## Backend Changes

### 1. Webhook Controller (`controllers/webhook.py`)

**Change `type='jsonrpc'` back to `type='json'`:**

In v18, `type='json'` is the correct decorator (v19 deprecated it in favor of `type='jsonrpc'`).

```python
# v19 (current)
@http.route([...], type='http', ...)

# v18 - Keep as type='http' since we're parsing JSON manually
# OR change to type='json' if you want Odoo to parse it:
@http.route([...], type='json', ...)
```

The current implementation uses `type='http'` and parses JSON manually, which works in both versions.

### 2. Mail Notification (`models/mail_notification.py`)

**Check `_to_store_defaults` method:**

v18 might have a different signature. Check the base `mail.notification` model:

```python
# v19 (current)
def _to_store_defaults(self, target):
    defaults = super()._to_store_defaults(target)
    return defaults + ["postal_state"]

# v18 - Verify the method exists and has the same signature
# If not, you may need to override _to_store() instead
```

### 3. Mail Resend Wizard (`wizard/mail_resend_message.py`)

**Change `_is_thread_message()` to `is_thread_message()`:**

In v18, the method doesn't have the underscore prefix:

```python
# v19 (current)
if message._is_thread_message():

# v18
if message.is_thread_message():
```

**Check `mail.mail` field names:**

```python
# v19 (current)
'is_notification': True,

# v18 - might be 'notification' instead
'notification': True,
```

Verify by checking the `mail.mail` model fields in v18.

## Frontend Changes

### 1. Notification Patch (`static/src/js/mail_notification_tracking/notification_patch.js`)

**Check Notification model import path:**

```javascript
// v19 (current)
import { Notification } from "@mail/core/common/notification_model";

// v18 - The path might be different
// Check in odoo/addons/mail/static/src/ for the correct path
// Possibly: import { Notification } from "@mail/models/notification";
```

### 2. Message Patch (`static/src/js/mail_notification_tracking/message_patch.js`)

**Check Message component import path:**

```javascript
// v19 (current)
import { Message } from "@mail/core/common/message";

// v18 - Check the correct import path
// Possibly: import { Message } from "@mail/components/message/message";
```

**Check `toRaw` import:**

```javascript
// v19 (current)
import { toRaw } from "@odoo/owl";

// v18 - OWL utilities might be imported differently
// Check if toRaw exists or use alternative
```

### 3. Service Registration

**Check service registry syntax:**

```javascript
// v19 (current)
registry.category("services").add("postal_popover_click", postalPopoverClickService);

// v18 - Should be the same, but verify
```

## XML Views

### 1. Settings View (`views/res_config_settings_views.xml`)

**Check xpath expressions:**

The settings view structure might differ. Verify the xpath targets exist in v18's `res.config.settings` form.

### 2. List View Attributes

**Check `export_xlsx` attribute:**

```xml
<!-- v19 (current) -->
<list ... export_xlsx="0">

<!-- v18 - This attribute might not exist, remove if it causes errors -->
<list ...>
```

## Testing Checklist

After migration, test:

1. [ ] Module installs without errors
2. [ ] Webhook endpoint receives and processes events
3. [ ] Tick icons display correctly in chatter
4. [ ] Click on ticks opens tracking popup
5. [ ] Bounce handling triggers resend dialog
6. [ ] Resend functionality works
7. [ ] Settings page shows webhook configuration

## Potential Issues

### OWL Component Structure

v18 and v19 have different OWL component structures in the mail module. The main challenge will be:

1. Finding correct import paths for `Notification` and `Message`
2. Ensuring the patch targets exist (`statusIcon`, `statusTitle` getters)
3. Verifying the popover structure for click handling

### Mail Module Refactoring

Odoo significantly refactored the mail module between versions. If patches don't work:

1. Check the v18 mail module source for component/model structure
2. Look for equivalent extension points
3. May need to rewrite patches using v18's patterns

## Resources

- Odoo v18 mail module: `odoo/addons/mail/static/src/`
- Odoo v18 OWL documentation
- Compare with v18 community modules that extend mail

## Quick Start

1. Copy module to v18 addons path
2. Update version in `__manifest__.py`
3. Fix import paths in JS files
4. Test installation
5. Fix any remaining issues based on error messages

