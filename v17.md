# Migration Guide: dr_postal v19 → v17

This document provides instructions for migrating the dr_postal module from Odoo v19 to v17.

## Overview

Odoo v17 has significant differences from v19, particularly in the mail module's frontend architecture. The migration requires more substantial changes than v18.

## Version Number

Update `__manifest__.py`:
```python
'version': '17.0.1.0.0',  # Changed from 19.0.1.0.0
```

## Major Architectural Differences

### OWL Version
- v17 uses OWL 2.x
- v19 uses OWL 2.x (but with different patterns)
- Component structure and lifecycle may differ

### Mail Module Structure
- v17's mail module has a different component hierarchy
- The `@mail/core/common/` path structure may not exist
- Models and components are organized differently

## Backend Changes

### 1. Webhook Controller (`controllers/webhook.py`)

**Use `type='json'` (not `type='jsonrpc'`):**

```python
# v19 (current) - uses type='http' with manual JSON parsing
# This should work in v17 as well

# Alternative for v17 with automatic JSON parsing:
@http.route(['/postal/webhook', '/postal/webhook/<string:token>'], 
            type='json', auth='none', methods=['POST'], csrf=False)
def postal_webhook(self, token=None, **kwargs):
    # In type='json' mode, request.jsonrequest contains parsed data
    data = request.jsonrequest
    ...
```

### 2. Mail Notification (`models/mail_notification.py`)

**Check `_to_store_defaults` existence:**

v17 might not have this method. You may need to use a different approach:

```python
# v19 (current)
def _to_store_defaults(self, target):
    defaults = super()._to_store_defaults(target)
    return defaults + ["postal_state"]

# v17 alternative - Override _to_store or message_format
def _to_store(self, store, fields=None, **kwargs):
    super()._to_store(store, fields, **kwargs)
    # Add postal_state to the store data
    ...
```

Check the v17 mail module to find the correct extension point.

### 3. Mail Resend Wizard (`wizard/mail_resend_message.py`)

**Method name changes:**

```python
# v19 (current)
if message._is_thread_message():

# v17 - Check if method exists and its name
# Might be: is_thread_message() or _is_thread_message() or different
```

**Check Command import:**

```python
# v19 (current)
from odoo import Command

# v17 - Command might need different import
from odoo.fields import Command
# or
from odoo.models import Command
```

### 4. View XML Changes

**Tree view vs List view:**

```xml
<!-- v19 (current) -->
<list string="...">

<!-- v17 - Might need 'tree' instead of 'list' -->
<tree string="...">
```

Check if v17 uses `<tree>` or `<list>` tag.

## Frontend Changes (MAJOR)

The frontend requires the most significant changes. v17's mail module has a different structure.

### 1. Find Correct Import Paths

**v19 paths (current):**
```javascript
import { Notification } from "@mail/core/common/notification_model";
import { Message } from "@mail/core/common/message";
```

**v17 paths (need to discover):**
```javascript
// Check odoo/addons/mail/static/src/ in v17 for correct paths
// Likely something like:
import { Notification } from "@mail/models/notification";
import { Message } from "@mail/components/message/message";
// or
import { Message } from "@mail/core/web/message";
```

### 2. Patch Syntax

**v19 (current):**
```javascript
import { patch } from "@web/core/utils/patch";

patch(Notification.prototype, {
    get statusIcon() { ... }
});
```

**v17 - Verify patch utility location and syntax:**
```javascript
// Path might be the same or different
import { patch } from "@web/core/utils/patch";

// Syntax should be similar but verify
patch(Notification.prototype, "dr_postal.NotificationPatch", {
    get statusIcon() { ... }
});
```

Note: v17 might require a patch name as second argument.

### 3. Service Dependencies

**v19 (current):**
```javascript
export const postalPopoverClickService = {
    dependencies: ["action"],
    start(env, { action }) { ... }
};
```

**v17 - Verify service registration:**
```javascript
// Service structure should be similar
// Check if dependencies syntax is the same
```

### 4. OWL Utilities

**v19 (current):**
```javascript
import { toRaw } from "@odoo/owl";
```

**v17:**
```javascript
// toRaw might be in a different location or not needed
// Check OWL 2.x documentation for v17
import { toRaw } from "@odoo/owl";
// or might need to access raw differently
```

### 5. Component Event Handling

**Check `markEventHandled` utility:**
```javascript
// v19 (current)
import { markEventHandled } from "@web/core/utils/misc";

// v17 - Verify this utility exists at this path
```

## Assets Declaration

**v19 (current):**
```python
'assets': {
    'web.assets_backend': [
        'dr_postal/static/src/css/dr_postal.css',
        'dr_postal/static/src/js/**/*',
    ],
},
```

**v17 - Should be similar but verify bundle names:**
```python
'assets': {
    'web.assets_backend': [
        'dr_postal/static/src/css/dr_postal.css',
        'dr_postal/static/src/js/**/*',
    ],
},
```

## Step-by-Step Migration Process

### Phase 1: Backend
1. Update version number
2. Test webhook controller (should work with minimal changes)
3. Fix model method names
4. Test backend functionality

### Phase 2: Frontend Discovery
1. Examine v17 mail module structure:
   ```
   odoo/addons/mail/static/src/
   ```
2. Find equivalent components/models for:
   - Notification model
   - Message component
   - MessageNotificationPopover
3. Document import paths

### Phase 3: Frontend Adaptation
1. Update import paths in all JS files
2. Adjust patch syntax if needed
3. Update service registration if needed
4. Test each feature individually

### Phase 4: Testing
1. [ ] Module installs
2. [ ] Webhook receives events
3. [ ] Events stored in database
4. [ ] Icons display in chatter
5. [ ] Click handlers work
6. [ ] Popups open correctly
7. [ ] Resend functionality works

## Fallback Strategy

If frontend patching proves too difficult:

### Option A: Simplified Frontend
Create a simpler implementation that:
- Only shows postal state in a separate widget
- Doesn't modify existing mail components
- Uses a button or menu to view tracking

### Option B: Server-Side Only
- Keep all backend functionality
- Remove frontend customizations
- View tracking via Settings → Technical → Postal Events menu

## Resources

- Odoo v17 mail module source code
- Odoo v17 JavaScript reference
- OWL 2.x documentation
- Compare with existing v17 mail extension modules on GitHub

## Known Challenges

1. **Mail module restructuring**: Odoo often restructures the mail module between major versions
2. **OWL component paths**: Import paths change frequently
3. **Patch compatibility**: The patch utility behavior may differ
4. **Store/Model system**: How data flows to frontend may be different

## Example: Discovering v17 Structure

Run this in browser console on a v17 Odoo instance:
```javascript
// Find available mail models
console.log(Object.keys(odoo.__DEBUG__.services));

// Find mail components
console.log(odoo.__DEBUG__.registry.category("components").entries());
```

This helps discover the correct import paths and available extension points.

