# DR Postal - Cursor AI Context

This document provides context for AI assistants working on this Odoo module.

## Project Overview

**dr_postal** is an Odoo v19 module that integrates with [Postal](https://postalserver.io/) mail server to provide WhatsApp-style email delivery tracking.

### Features
- **Real-time tracking**: Sent, Delivered, Opened, and Bounced status via webhooks
- **WhatsApp-style visual indicators**:
  - ✓ (1 grey tick) = Sent to mail server (Odoo delivered to Postal, no webhook yet)
  - ✓✓ (2 grey ticks) = SMTP confirmed / Delivered (Postal webhook received)
  - ✓✓ (2 blue ticks) = Opened/Read
  - Red envelope (Odoo default) = Bounced/Failed
- **Resend failed emails**: Custom dialog (ported from v18) to retry or ignore bounced emails
- **Event audit log**: Full history of postal events viewable via click on tick icons
- **Clean popup dialogs**: Wizard-based popups that render cleanly without CSS hacks

## Architecture

### Backend (Python)

```
dr_postal/
├── controllers/
│   └── webhook.py          # Postal webhook endpoint (/postal/webhook/<token>)
├── models/
│   ├── mail_postal_event.py    # Event log model for tracking history
│   ├── mail_notification.py    # Extends mail.notification with postal_state
│   ├── mail_mail.py            # Adds tracking headers to outgoing emails
│   ├── mail_message.py         # Extends mail.message (minimal)
│   └── res_config_settings.py  # Webhook token configuration
└── wizard/
    ├── mail_resend_message.py      # Resend failed emails wizard
    └── mail_postal_events_popup.py # Email tracking popup wizard
```

### Frontend (JavaScript - OWL)

```
static/src/js/mail_notification_tracking/
├── notification_patch.js              # Patches Notification model (statusIcon, statusTitle)
├── message_patch.js                   # Patches Message component (click handling)
└── message_notification_popover_patch.js  # Global click service for tick icons
```

### Key Design Decisions

1. **Wizard-based popups**: Both the resend dialog and email tracking popup use transient models with form views. This renders cleanly without CSS hacks (vs. list view with `target="new"` which shows search bars, etc.).

2. **Global click service**: The tick icons appear inside `MessageNotificationPopover` which is dynamically created. A global document click listener handles clicks on `.o_dr_postal_status` elements.

3. **State stored globally**: `postalPopoverState.currentMessageId` stores the message ID when the popover opens, so the click service can access it.

4. **Bounce handling**: Bounced emails set `notification_status='bounce'` and `failure_type='mail_bounce'` to trigger Odoo's built-in bounce UI. The custom resend wizard handles the retry logic.

## Postal Webhook Format

Postal sends webhooks in this structure:
```json
{
    "event": "MessageSent",
    "timestamp": 1764515384.93,
    "uuid": "...",
    "payload": {
        "message": {
            "id": 7469,
            "message_id": "xxx-openerp-8-res.partner@domain",
            "to": "recipient@example.com",
            "from": "sender@example.com",
            ...
        },
        "status": "Sent",
        "details": "...",
        ...
    }
}
```

Event types mapped:
- `MessageSent` → `sent`
- `MessageDelayed` → `sent`
- `MessageDeliveryFailed` → `bounced`
- `MessageHeld` → `sent`
- `MessageBounced` → `bounced`
- `MessageLinkClicked` → `opened`
- `MessageLoaded` → `opened`

## Configuration

1. Settings → Discuss → Postal Tracking
2. Set webhook token
3. Configure Postal to send webhooks to: `{odoo_url}/postal/webhook/{token}`

## Common Issues & Solutions

### Issue: Module not recognized in app list
- Ensure `'application': True` in `__manifest__.py`
- For Odoo.sh: Module must be in a subdirectory (e.g., `dr_postal/dr_postal/`)

### Issue: Popup shows all columns / search bar
- Use wizard (transient model) with form view containing embedded list
- Don't use `ir.actions.act_window` with `view_mode="list"` and `target="new"`

### Issue: Click on tick icons doesn't work
- The icons are in a dynamically created popover
- Use global document click listener, not component-level handlers
- Store message ID in global state when popover opens

### Issue: Resend creates duplicate notifications
- Don't create new `mail.notification` records
- Update existing notification's status and create new `mail.mail`

## Odoo v19 Specifics

- `@route(type='jsonrpc')` instead of deprecated `type='json'`
- `_is_thread_message()` method (with underscore prefix)
- `is_notification` field on `mail.mail` (not `notification`)
- `_to_store_defaults()` method for adding fields to frontend store
- No `groups_id` field on `ir.ui.view`
- No `Record.attr()` in frontend (use direct property access)

## Files to Check When Debugging

1. **Webhook not receiving events**: `controllers/webhook.py`
2. **Icons not showing**: `notification_patch.js`, `dr_postal.css`
3. **Click not working**: `message_patch.js`, `message_notification_popover_patch.js`
4. **Popup issues**: `wizard/mail_postal_events_popup*.py/xml`
5. **Resend not working**: `wizard/mail_resend_message.py`

## Testing Webhooks

Use curl to simulate Postal webhooks:
```bash
curl -X POST https://your-odoo.com/postal/webhook/YOUR_TOKEN \
  -H "Content-Type: application/json" \
  -d '{
    "event": "MessageSent",
    "timestamp": 1764515384.93,
    "uuid": "test-uuid",
    "payload": {
      "message": {
        "message_id": "your-message-id@domain",
        "to": "recipient@example.com"
      },
      "status": "Sent"
    }
  }'
```

